<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Upload Files</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: system-ui; background:#0f0f12; color:white; max-width:520px; margin:auto; padding:40px }
  .nav-header { margin-bottom: 20px; }
  .nav-header a { color: #6c7cff; text-decoration: none; font-size: 14px; }
  input, select, button { width:100%; padding:12px; margin-top:12px; border-radius:10px; border:none; box-sizing: border-box; }
  button { background:#6c7cff; color:white; font-weight:600; cursor:pointer }
  .card { background:#16161d; padding:20px; border-radius:16px }
  #msg { margin-top: 15px; font-size: 14px; line-height: 1.6; }
</style>
</head>
<body>

<div class="nav-header">
  <a href="index.html">← Back to Library</a>
</div>

<h2>Upload to your library</h2>

<div class="card" id="loginBox">
  <input id="email" placeholder="your email" />
  <button onclick="login()">Send login link</button>
</div>

<div class="card" id="uploadBox" style="display:none">
  <input type="file" id="fileInput" />
  <input placeholder="Display name" id="displayName" />
  <input placeholder="Category (ex: Design, Finance)" id="category" />
  <button onclick="upload()">Upload</button>
  <p id="msg"></p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient("https://cvuigmevznxkgnmleuta.supabase.co", "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q")

const loginBox = document.getElementById("loginBox")
const uploadBox = document.getElementById("uploadBox")

supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    loginBox.style.display = "none"
    uploadBox.style.display = "block"
  }
})

window.login = async () => {
  const email = document.getElementById("email").value
  await supabase.auth.signInWithOtp({ 
    email,
    options: { emailRedirectTo: window.location.href }
  })
  alert("Check your email for the magic link!")
}

window.upload = async () => {
  const fileInput = document.getElementById("fileInput");
  const displayNameElem = document.getElementById("displayName");
  const categoryElem = document.getElementById("category");
  const msg = document.getElementById("msg");

  const file = fileInput.files[0]
  if (!file) return alert("Please select a file first");

  const displayName = displayNameElem.value || file.name
  const category = categoryElem.value || "Unsorted"
  const fileName = `${Date.now()}-${file.name.replace(/\s+/g, '_')}`

  msg.innerText = "Uploading..."

  // 確保使用大寫 Files
  const { error: storageError } = await supabase.storage.from("Files").upload(fileName, file)
  if (storageError) return msg.innerText = "Error: " + storageError.message

  const { error: dbError } = await supabase.from("files").insert({
    storage_path: fileName,
    display_name: displayName,
    category: category
  })

  if (dbError) {
    msg.innerText = "Database Error: " + dbError.message
  } else {
    msg.innerHTML = `
      <div style="color:#4ade80">Uploaded ✅</div>
      <button onclick="location.reload()" style="background:#444; margin-top:10px">Upload Another</button>
      <button onclick="location.href='index.html'" style="background:#222; margin-top:10px">View in Library</button>
    `;
  }
}
</script>
</body>
</html>

