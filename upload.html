<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Upload Files</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: system-ui; background:#0f0f12; color:white; max-width:520px; margin:auto; padding:40px }
input, select, button { width:100%; padding:12px; margin-top:12px; border-radius:10px; border:none }
button { background:#6c7cff; color:white; font-weight:600; cursor:pointer }
.card { background:#16161d; padding:20px; border-radius:16px }
</style>
</head>
<body>

<h2>Upload to your library</h2>

<div class="card" id="loginBox">
  <input id="email" placeholder="your email" />
  <button onclick="login()">Send login link</button>
</div>

<div class="card" id="uploadBox" style="display:none">
  <input type="file" id="fileInput" />
  <input placeholder="Display name" id="displayName" />
  <input placeholder="Category (ex: Design, Finance)" id="category" />
  <button onclick="upload()">Upload</button>
  <p id="msg"></p>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://cvuigmevznxkgnmleuta.supabase.co",
  "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q"
)

const loginBox = document.getElementById("loginBox")
const uploadBox = document.getElementById("uploadBox")

supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    loginBox.style.display = "none"
    uploadBox.style.display = "block"
  }
})


window.login = async () => {
  const email = document.getElementById("email").value;
  
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: window.location.href 
    }
  });

  if (error) {
    alert("錯誤：" + error.message);
  } else {
    alert("請檢查信箱，點擊連結後將自動回到此頁面並顯示上傳區");
  }
};

window.upload = async () => {
  // 正確地獲取畫面上的元素
  const fileInput = document.getElementById("fileInput");
  const displayNameElem = document.getElementById("displayName");
  const categoryElem = document.getElementById("category");
  const msg = document.getElementById("msg");

  const file = fileInput.files[0];
  if (!file) return alert("請先選擇檔案");

  // 使用抓取到的元素值，如果沒填寫就用檔名代替
  const displayName = displayNameElem.value || file.name;
  const category = categoryElem.value || "Unsorted";

  const fileName = `${Date.now()}-${file.name}`;

  msg.innerText = "Uploading...";

  // 1. 上傳到 Storage
  const { error: storageError } = await supabase.storage.from("files").upload(fileName, file);
  if (storageError) return msg.innerText = "上傳失敗：" + storageError.message;

  // 2. 寫入資料庫
  const { error: dbError } = await supabase.from("files").insert({
    storage_path: fileName,
    display_name: displayName,
    category: category
  });

  if (dbError) {
    msg.innerText = "資料庫寫入失敗：" + dbError.message;
  } else {
    msg.innerHTML = `
      Uploaded ✅ <br>
      <button onclick="location.reload()" style="background:#444; margin-top:10px">繼續上傳</button>
      <button onclick="location.href='index.html'" style="background:#222; margin-top:10px">回到首頁看結果</button>
    `;
  }
};
</script>

</body>
</html>