<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Manage Content</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg: #f7f7f5; --text: #37352f; --border: #edeef0; --accent: #2383e2; --danger: #eb5757; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
  
  .nav-container, .container { max-width: 900px; margin: 0 auto; padding: 0 20px; box-sizing: border-box; }
  .navbar { background: white; border-bottom: 1px solid var(--border); margin-bottom: 40px; }
  .nav-container { display: flex; align-items: center; height: 60px; }
  .nav-back { color: var(--secondary); text-decoration: none; font-size: 14px; font-weight: 500; }
  
  .card { background: white; padding: 32px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 32px; }
  
  /* Drag & Drop */
  .drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 40px; text-align: center; color: #888; cursor: pointer; transition: 0.2s; background: #fafafa; margin-bottom: 20px; }
  .drop-zone.dragover { border-color: var(--accent); background: #f0f7ff; color: var(--accent); }
  
  input { padding: 10px; border-radius: 6px; border: 1px solid var(--border); box-sizing: border-box; font-size: 14px; width: 100%; }
  .upload-fields { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 12px; margin-top: 12px; }
  .btn-up { background: var(--accent); color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 20px; }
  
  /* File List Management */
  .file-item { background: white; padding: 14px 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
  .file-info { flex: 1; display: flex; align-items: center; gap: 12px; }
  .btn-action { background: none; border: none; font-size: 13px; cursor: pointer; color: var(--secondary); }
  .btn-save { color: var(--accent); font-weight: 600; }
  .btn-del { color: var(--danger); }
</style>
</head>
<body>

<nav class="navbar">
  <div class="nav-container">
    <a href="index.html" class="nav-back">‚Üê Back to Library</a>
  </div>
</nav>

<div class="container">
  <div id="loginBox" class="card" style="text-align:center">
    <h2>Admin Login</h2>
    <input id="email" placeholder="Your email" style="max-width:300px"/>
    <button onclick="login()" class="btn-up" style="max-width:300px">Send Magic Link</button>
  </div>

  <div id="uploadBox" style="display:none">
    <div class="card">
      <div id="dropZone" class="drop-zone">Drag & drop files here or click to browse</div>
      <input type="file" id="fileInput" style="display:none" />
      
      <div class="upload-fields">
        <input id="emoji" placeholder="Emoji" title="ÈªûÊìäÂæåÊåâ Cmd+Ctrl+Space" />
        <input id="displayName" placeholder="Display name" />
        <input id="category" placeholder="Category" />
      </div>
      <button id="upBtn" onclick="upload()" class="btn-up">Upload to Library</button>
    </div>

    <h3 style="color: #888; font-size: 12px; text-transform: uppercase; margin: 40px 0 16px;">Management</h3>
    <div id="list"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
const supabase = createClient("https://cvuigmevznxkgnmleuta.supabase.co", "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q")

// --- Drag & Drop & Detection Logic ---
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");

dropZone.onclick = () => fileInput.click();
dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add("dragover"); };
dropZone.ondragleave = () => dropZone.classList.remove("dragover");
dropZone.ondrop = (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
};
fileInput.onchange = () => handleFileSelect(fileInput.files[0]);

function handleFileSelect(file) {
  if (!file) return;
  // ‚úÖ Ê≠£Á¢∫‰∏îÁõ∏ÂÆπÁöÑÂØ´Ê≥ï
  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(file);
  fileInput.files = dataTransfer.files;

  document.getElementById("dropZone").innerText = `Selected: ${file.name}`;
  
  const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
  document.getElementById("displayName").value = baseName;
  
  const ext = file.name.split('.').pop().toLowerCase();
  const emojiMap = { 'pdf': 'üìï', 'jpg': 'üé®', 'png': 'üé®', 'mp4': 'üé¨', 'xls': 'üìä', 'xlsx': 'üìä' };
  document.getElementById("emoji").value = emojiMap[ext] || 'üìÑ';
}

// --- Supabase Logic ---
supabase.auth.onAuthStateChange(async (_, s) => {
  if (s) {
    document.getElementById("loginBox").style.display="none";
    document.getElementById("uploadBox").style.display="block";
    refreshList();
  }
});

window.login = async () => {
  const email = document.getElementById("email").value;
  await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  alert("Check your email!");
};

async function refreshList() {
  const { data } = await supabase.from("files").select("*").order("created_at",{ascending:false});
  document.getElementById("list").innerHTML = data?.map(f => `
    <div class="file-item" id="item-${f.id}">
      <span style="font-size:24px">${f.emoji}</span>
      <div class="file-info" id="info-${f.id}">
        <div style="font-weight:600; font-size:14px">${f.display_name}</div>
        <div style="font-size:11px; color:#aaa; font-weight:600; text-transform:uppercase">${f.category}</div>
      </div>
      <div class="actions">
        <button class="btn-action" onclick="enableEdit('${f.id}', '${f.display_name}', '${f.category}')">Edit</button>
        <button class="btn-action btn-del" onclick="deleteFile('${f.id}','${f.storage_path}')">Delete</button>
      </div>
    </div>
  `).join('');
}

window.enableEdit = (id, n, c) => {
  document.getElementById(`info-${id}`).innerHTML = `
    <input id="en-${id}" value="${n}" style="margin-bottom:4px" />
    <input id="ec-${id}" value="${c}" />
  `;
  document.querySelector(`#item-${id} .actions`).innerHTML = `
    <button class="btn-action btn-save" onclick="saveEdit('${id}')">Save</button>
  `;
}

window.saveEdit = async (id) => {
  const n = document.getElementById(`en-${id}`).value;
  const c = document.getElementById(`ec-${id}`).value;
  await supabase.from("files").update({ display_name: n, category: c }).eq('id', id);
  refreshList();
}

window.upload = async () => {
  const f = fileInput.files[0];
  if(!f) return alert("Select file");
  const btn = document.getElementById("upBtn");
  btn.innerText = "Uploading..."; btn.disabled = true;

  const path = `${Date.now()}-${f.name.replace(/\s+/g,'_')}`;
  await supabase.storage.from("Files").upload(path, f);
  await supabase.from("files").insert({
    storage_path: path,
    display_name: document.getElementById("displayName").value || f.name,
    category: document.getElementById("category").value || "Unsorted",
    emoji: document.getElementById("emoji").value || 'üìÑ'
  });
  
  btn.innerText = "Upload to Library"; btn.disabled = false;
  document.getElementById("displayName").value = "";
  refreshList();
}

window.deleteFile = async (id, p) => {
  if(confirm("Delete?")) {
    await supabase.storage.from("Files").remove([p]);
    await supabase.from("files").delete().eq('id', id);
    refreshList();
  }
}
</script>
</body>
</html>