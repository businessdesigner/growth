<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>Library Manager - Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg: #f7f7f5; --text: #37352f; --border: #edeef0; --accent: #2383e2; --danger: #eb5757; --secondary: #757575; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
  
  /* Navigation */
  .navbar { background: white; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
  .nav-container { max-width: 900px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
  .nav-link { color: var(--secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: 0.2s; }
  .nav-link:hover { color: var(--text); }
  .nav-accent { color: var(--accent); font-weight: 700; }

  /* Content Layout */
  .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; }
  .card { background: white; padding: 32px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.04); margin-bottom: 32px; }
  
  /* Upload Elements */
  .drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 48px; text-align: center; color: #a1a1a1; cursor: pointer; transition: 0.2s; background: #fafafa; margin-bottom: 24px; }
  .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: #f0f7ff; color: var(--accent); }
  
  .upload-fields { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 12px; }
  input { padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; width: 100%; box-sizing: border-box; }
  .btn-up { background: var(--accent); color: white; width: 100%; padding: 14px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 24px; transition: opacity 0.2s; }
  .btn-up:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Management List */
  .section-title { font-size: 12px; font-weight: 700; color: #a1a1a1; text-transform: uppercase; letter-spacing: 0.05em; margin: 48px 0 16px; }
  .file-item { background: white; padding: 16px 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
  .file-info { flex: 1; }
  .file-info b { display: block; font-size: 14px; margin-bottom: 2px; }
  .file-info small { color: var(--secondary); font-size: 11px; font-weight: 600; text-transform: uppercase; }
  
  .actions { display: flex; gap: 12px; }
  .btn-action { background: none; border: none; font-size: 13px; cursor: pointer; color: var(--secondary); font-weight: 500; }
  .btn-save { color: var(--accent); font-weight: 700; }
  .btn-del { color: var(--danger); }
</style>
</head>
<body>

<nav class="navbar">
  <div class="nav-container">
    <a href="index.html" class="nav-link">â† æŸ¥çœ‹é¦–é </a>
    <a href="exporter.html" class="nav-link nav-accent">â” æ­¥é©ŸäºŒï¼šåŒ¯å‡º JSON è³‡æ–™</a>
  </div>
</nav>

<div class="container">
  <div id="loginBox" class="card" style="text-align:center">
    <h2 style="margin-top:0">ç®¡ç†å“¡ç™»å…¥</h2>
    <p style="color:var(--secondary); font-size:14px">è«‹è¼¸å…¥ Email ä»¥ç²å–ç™»å…¥é€£çµ</p>
    <input id="email" placeholder="you@example.com" style="max-width:320px; margin: 10px auto; display:block" />
    <button onclick="login()" class="btn-up" style="max-width:320px">ç™¼é€ç™»å…¥éƒµä»¶</button>
  </div>

  <div id="uploadBox" style="display:none">
    <div class="card">
      <div id="dropZone" class="drop-zone">å°‡æª”æ¡ˆæ‹–æ›³è‡³æ­¤ï¼Œæˆ–é»æ“Šç€è¦½æª”æ¡ˆ</div>
      <input type="file" id="fileInput" style="display:none" />
      
      <div class="upload-fields">
        <input id="emoji" placeholder="åœ–ç¤º" title="é»æ“ŠæŒ‰ Cmd+Ctrl+Space é¸å–" />
        <input id="displayName" placeholder="é¡¯ç¤ºåç¨±" />
        <input id="category" placeholder="åˆ†é¡ (ä¾‹å¦‚: Project, Case)" />
      </div>
      <button id="upBtn" onclick="upload()" class="btn-up">ä¸Šå‚³è‡³è³‡æ–™åº«</button>
    </div>

    <div class="section-title">ç›®å‰å·²ä¸Šå‚³çš„æª”æ¡ˆ</div>
    <div id="list"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
const supabase = createClient("https://cvuigmevznxkgnmleuta.supabase.co", "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q")

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");

// --- æª”æ¡ˆåµæ¸¬é‚è¼¯ ---
dropZone.onclick = () => fileInput.click();
dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add("dragover"); };
dropZone.ondragleave = () => dropZone.classList.remove("dragover");
dropZone.ondrop = (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
};
fileInput.onchange = () => handleFileSelect(fileInput.files[0]);

function handleFileSelect(file) {
  if (!file) return;
  // ä¿®æ­£ DataTransfer å”¯è®€å•é¡Œ
  const dt = new DataTransfer();
  dt.items.add(file);
  fileInput.files = dt.files;

  dropZone.innerText = `å·²é¸å–: ${file.name}`;
  
  // è‡ªå‹•é å¡«æª”å
  const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
  document.getElementById("displayName").value = baseName;
  
  // è‡ªå‹•åµæ¸¬å»ºè­° Emoji
  const ext = file.name.split('.').pop().toLowerCase();
  const emojiMap = { 'pdf': 'ğŸ“•', 'jpg': 'ğŸ¨', 'png': 'ğŸ–¼ï¸', 'mp4': 'ğŸ¬', 'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'zip': 'ğŸ“¦' };
  document.getElementById("emoji").value = emojiMap[ext] || 'ğŸ“„';
}

// --- ç™»å…¥é‚è¼¯ ---
supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("uploadBox").style.display = "block";
    refreshList();
  }
});

window.login = async () => {
  const email = document.getElementById("email").value;
  const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  if (error) alert(error.message); else alert("è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ä»¥å®Œæˆç™»å…¥ï¼");
};

// --- ç®¡ç†åˆ—è¡¨é‚è¼¯ ---
async function refreshList() {
  const { data } = await supabase.from("files").select("*").order("created_at", { ascending: false });
  const listDiv = document.getElementById("list");
  listDiv.innerHTML = data.map(f => `
    <div class="file-item" id="item-${f.id}">
      <span style="font-size:24px">${f.emoji || 'ğŸ“„'}</span>
      <div class="file-info" id="info-${f.id}">
        <b>${f.display_name}</b>
        <small>${f.category}</small>
      </div>
      <div class="actions">
        <button class="btn-action" onclick="enableEdit('${f.id}', '${f.display_name}', '${f.category}')">ç·¨è¼¯</button>
        <button class="btn-action btn-del" onclick="deleteFile('${f.id}', '${f.storage_path}')">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

window.enableEdit = (id, n, c) => {
  document.getElementById(`info-${id}`).innerHTML = `
    <input id="en-${id}" value="${n}" style="margin-bottom:4px; padding:4px" />
    <input id="ec-${id}" value="${c}" style="padding:4px" />
  `;
  const actionDiv = document.querySelector(`#item-${id} .actions`);
  actionDiv.innerHTML = `<button class="btn-action btn-save" onclick="saveEdit('${id}')">å„²å­˜</button>`;
}

window.saveEdit = async (id) => {
  const n = document.getElementById(`en-${id}`).value;
  const c = document.getElementById(`ec-${id}`).value;
  await supabase.from("files").update({ display_name: n, category: c }).eq('id', id);
  refreshList();
}

// --- ä¸Šå‚³é‚è¼¯ ---
window.upload = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("è«‹å…ˆé¸å–æª”æ¡ˆ");
  
  const btn = document.getElementById("upBtn");
  btn.innerText = "ä¸Šå‚³ä¸­..."; btn.disabled = true;

  const path = `${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
  
  try {
    const { error: storageErr } = await supabase.storage.from("Files").upload(path, file);
    if (storageErr) throw storageErr;

    await supabase.from("files").insert({
      storage_path: path,
      display_name: document.getElementById("displayName").value || file.name,
      category: document.getElementById("category").value || "æœªåˆ†é¡",
      emoji: document.getElementById("emoji").value || 'ğŸ“„'
    });

    alert("ä¸Šå‚³æˆåŠŸï¼");
    location.reload(); 
  } catch (err) {
    alert("ä¸Šå‚³å¤±æ•—: " + err.message);
    btn.innerText = "ä¸Šå‚³è‡³è³‡æ–™åº«"; btn.disabled = false;
  }
}

window.deleteFile = async (id, path) => {
  if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æª”æ¡ˆå—ï¼Ÿ")) {
    await supabase.storage.from("Files").remove([path]);
    await supabase.from("files").delete().eq('id', id);
    refreshList();
  }
}
</script>
</body>
</html>