<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Manage Files</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg: #f7f7f5; --text: #37352f; --border: #edeef0; --accent: #2383e2; --danger: #eb5757; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 40px 20px; }
  .container { max-width: 800px; margin: 0 auto; }
  .card { background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 24px; }
  
  /* æ‹–æ‹½å€åŸŸæ¨£å¼ */
  .drop-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; color: #888; transition: 0.2s; cursor: pointer; margin-bottom: 16px; background: #fafafa; }
  .drop-zone.dragover { border-color: var(--accent); background: #f0f7ff; color: var(--accent); }
  
  input, select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); box-sizing: border-box; font-size: 14px; }
  .btn-up { background: var(--accent); color: white; width: 100%; margin-top: 12px; height: 40px; border: none; font-weight: 600; cursor: pointer; }
  .file-list { display: flex; flex-direction: column; gap: 12px; }
  .file-item { background: white; padding: 16px; border-radius: 10px; border: 1px solid var(--border); display: flex; align-items: center; gap: 16px; }
  .file-content { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
  .actions { display: flex; gap: 8px; }
  .btn-text { background: transparent; color: #888; font-size: 13px; padding: 4px; border: none; cursor: pointer; }
  .btn-save { color: var(--accent); }
  .btn-del { color: var(--danger); }
</style>
</head>
<body>

<div class="container">
  <a href="index.html" style="text-decoration:none; color:var(--accent); font-size:14px">â† View Library</a>
  
  <div id="uploadBox" style="display:none; margin-top:20px">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size: 20px;">Add Content</h2>
      
      <div id="dropZone" class="drop-zone">
        <span id="dropText">Drag & drop files here or click to browse</span>
        <input type="file" id="fileInput" style="display:none" />
      </div>

      <div style="display:flex; gap:8px">
        <select id="emojiSelect" style="width: 80px;">
          <option value="ğŸ“„">ğŸ“„</option><option value="ğŸ“•">ğŸ“•</option><option value="ğŸ¨">ğŸ¨</option>
          <option value="ğŸ“Š">ğŸ“Š</option><option value="ğŸ¬">ğŸ¬</option><option value="âš™ï¸">âš™ï¸</option>
        </select>
        <input id="displayName" placeholder="Display name" style="flex:1" />
        <input id="category" placeholder="Category" style="flex:1" />
      </div>
      <button onclick="upload()" id="upBtn" class="btn-up">Upload to Library</button>
      <p id="msg" style="font-size:12px; color: #666; margin-top: 10px;"></p>
    </div>

    <h3 style="font-size: 14px; color: #888; text-transform: uppercase; margin-bottom: 16px;">Files in Library</h3>
    <div id="list" class="file-list"></div>
  </div>

  <div id="loginBox" class="card" style="margin-top:20px; text-align:center;">
    <h2>Admin Login</h2>
    <input id="email" placeholder="Your email" style="max-width:300px"/>
    <button onclick="login()" class="btn-up" style="max-width:300px">Send Magic Link</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
const supabase = createClient("https://cvuigmevznxkgnmleuta.supabase.co", "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q")

// --- ä»‹é¢æ§åˆ¶é‚è¼¯ ---
const dropZone = document.getElementById("dropZone")
const fileInput = document.getElementById("fileInput")
const dropText = document.getElementById("dropText")
const emojiSelect = document.getElementById("emojiSelect")
const displayName = document.getElementById("displayName")

// é»æ“Šå€åŸŸè§¸ç™¼é¸æ“‡
dropZone.onclick = () => fileInput.click()

// æ‹–æ‹½è¦–è¦ºæ•ˆæœ
dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add("dragover") }
dropZone.ondragleave = () => dropZone.classList.remove("dragover")

// è™•ç†æª”æ¡ˆæ”¾å…¥å¾Œçš„ã€Œè‡ªå‹•åµæ¸¬ã€
dropZone.ondrop = (e) => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  if (e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    handleFileSelection(e.dataTransfer.files[0]);
  }
}

fileInput.onchange = () => {
  if (fileInput.files.length) handleFileSelection(fileInput.files[0]);
}

function handleFileSelection(file) {
  dropText.innerText = `Selected: ${file.name}`;
  
  // 1. è‡ªå‹•å¡«å…¥æª”åï¼ˆå»é™¤å‰¯æª”åï¼‰
  const baseName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
  displayName.value = baseName;

  // 2. è‡ªå‹•åµæ¸¬ Emoji
  const ext = file.name.split('.').pop().toLowerCase();
  const emojiMap = {
    'pdf': 'ğŸ“•',
    'jpg': 'ğŸ¨', 'jpeg': 'ğŸ¨', 'png': 'ğŸ¨', 'svg': 'ğŸ¨',
    'mp4': 'ğŸ¬', 'mov': 'ğŸ¬',
    'csv': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'json': 'ğŸ“Š',
    'zip': 'âš™ï¸', 'exe': 'âš™ï¸'
  };
  emojiSelect.value = emojiMap[ext] || 'ğŸ“„';
}

// --- Supabase åŠŸèƒ½é‚è¼¯ ---
supabase.auth.onAuthStateChange(async (_, session) => {
  if (session) {
    document.getElementById("loginBox").style.display = "none"
    document.getElementById("uploadBox").style.display = "block"
    refreshList()
  }
})

window.login = async () => {
  const email = document.getElementById("email").value
  await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } })
  alert("Check your email!")
}

async function refreshList() {
  const { data } = await supabase.from("files").select("*").order("created_at", {ascending:false})
  document.getElementById("list").innerHTML = data?.map(f => `
    <div class="file-item" id="item-${f.id}">
      <span style="font-size:24px">${f.emoji || 'ğŸ“„'}</span>
      <div class="file-content" id="content-${f.id}">
        <div style="font-weight:600">${f.display_name}</div>
        <div style="font-size:12px; color:#888">${f.category}</div>
      </div>
      <div class="actions">
        <button class="btn-text" onclick="enableEdit('${f.id}', '${f.display_name}', '${f.category}')">Edit</button>
        <button class="btn-text btn-del" onclick="deleteFile('${f.id}', '${f.storage_path}')">Delete</button>
      </div>
    </div>
  `).join('') || ""
}

window.enableEdit = (id, name, cat) => {
  const content = document.getElementById(`content-${id}`);
  content.innerHTML = `<input id="en-${id}" value="${name}" /><input id="ec-${id}" value="${cat}" />`;
  const actions = document.querySelector(`#item-${id} .actions`);
  actions.innerHTML = `<button class="btn-text btn-save" onclick="saveEdit('${id}')">Save</button>`;
}

window.saveEdit = async (id) => {
  const newName = document.getElementById(`en-${id}`).value;
  const newCat = document.getElementById(`ec-${id}`).value;
  await supabase.from("files").update({ display_name: newName, category: newCat }).eq('id', id);
  refreshList();
}

window.upload = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("Select file");
  const upBtn = document.getElementById("upBtn");
  upBtn.innerText = "Uploading..."; upBtn.disabled = true;

  const path = `${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
  await supabase.storage.from("Files").upload(path, file);
  await supabase.from("files").insert({
    storage_path: path,
    display_name: displayName.value || file.name,
    category: document.getElementById("category").value || "Unsorted",
    emoji: emojiSelect.value
  });

  upBtn.innerText = "Upload to Library"; upBtn.disabled = false;
  dropText.innerText = "Drag & drop files here or click to browse";
  displayName.value = "";
  refreshList();
}

window.deleteFile = async (id, path) => {
  if (confirm("Delete file?")) {
    await supabase.storage.from("Files").remove([path]);
    await supabase.from("files").delete().eq('id', id);
    refreshList();
  }
}
</script>
</body>
</html>