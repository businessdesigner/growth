<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>Admin - Upload & Manage</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg: #f7f7f5; --text: #37352f; --border: #edeef0; --accent: #2383e2; --secondary: #757575; --info-bg: #ebf5ff; --info-text: #2b78c5; }
  body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
  
  /* Navbar */
  .navbar { background: white; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
  .nav-container { max-width: 900px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
  .nav-link { color: var(--secondary); text-decoration: none; font-size: 14px; font-weight: 500; }
  
  /* Workflow Hint Banner */
  .workflow-hint { background: var(--info-bg); color: var(--info-text); border-bottom: 1px solid #d0e7ff; padding: 12px 20px; font-size: 13px; line-height: 1.5; text-align: center; }
  .workflow-hint b { color: var(--accent); }

  .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
  .card { background: white; padding: 32px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; }
  
  /* Upload Elements */
  .drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 40px; text-align: center; color: #888; cursor: pointer; background: #fafafa; }
  .upload-fields { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 12px; margin-top: 20px; }
  input { padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; width: 100%; box-sizing: border-box; }
  .btn-up { background: var(--accent); color: white; width: 100%; padding: 14px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 20px; }
  
  .file-item { background: white; padding: 16px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px; display: flex; align-items: center; gap: 15px; }
  .actions { margin-left: auto; }
  .btn-del { color: #eb5757; border: none; background: none; cursor: pointer; font-size: 13px; }
</style>
</head>
<body>

<nav class="navbar">
  <div class="nav-container">
    <a href="index.html" class="nav-link">â† æŸ¥çœ‹é¦–é </a>
    <a href="exporter.html" class="nav-link" style="color:var(--accent); font-weight:700">â” åŸ·è¡Œæ­¥é©ŸäºŒï¼šåŒ¯å‡ºè³‡æ–™</a>
  </div>
</nav>

<div class="workflow-hint">
  ğŸ’¡ <b>ç¶­è­·æé†’ï¼š</b>ä¸Šå‚³å®Œæˆå¾Œï¼Œè«‹å‹™å¿…å‰å¾€ã€ŒåŒ¯å‡ºè³‡æ–™ã€é é¢ä¸‹è¼‰æœ€æ–°çš„ <code>data.json</code>ï¼Œè¦†è“‹å°ˆæ¡ˆæª”æ¡ˆå¾Œé‡æ–° <b>Commit & Push</b> è‡³ GitHub ä»¥åŒæ­¥æ›´æ–°ã€‚
</div>

<div class="container">
  <div id="loginBox" class="card" style="text-align:center">
    <h2>ç®¡ç†å“¡ç™»å…¥</h2>
    <input id="email" type="email" placeholder="è¼¸å…¥æ‚¨çš„ Email" style="max-width:300px; margin-bottom:10px" />
    <button onclick="login()" class="btn-up" style="max-width:300px">ç™¼é€ Magic Link</button>
  </div>

  <div id="uploadBox" style="display:none">
    <div class="card">
      <div id="dropZone" class="drop-zone">æ‹–æ›³æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šé¸å–æª”æ¡ˆ</div>
      <input type="file" id="fileInput" style="display:none" />
      
      <div class="upload-fields">
        <input id="emoji" placeholder="åœ–ç¤º" />
        <input id="displayName" placeholder="æª”æ¡ˆåç¨±" />
        <input id="category" list="categoryOptions" placeholder="é¸æ“‡æˆ–è¼¸å…¥åˆ†é¡" />
        <datalist id="categoryOptions"></datalist>
      </div>
      <button id="upBtn" onclick="upload()" class="btn-up">ä¸Šå‚³è‡³ Supabase</button>
    </div>

    <h3 style="font-size: 14px; color: var(--secondary); margin-bottom: 12px;">è³‡æ–™åº«ç¾æœ‰æª”æ¡ˆ</h3>
    <div id="list"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
const supabase = createClient("https://cvuigmevznxkgnmleuta.supabase.co", "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q")

// ç‹€æ…‹ç›£æ§
supabase.auth.onAuthStateChange((event, session) => {
  if (session) {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('uploadBox').style.display = 'block';
    refreshList();
  }
});

// ç™»å…¥
window.login = async () => {
  const email = document.getElementById('email').value;
  const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  if (error) alert(error.message); else alert("ç™»å…¥ä¿¡ä»¶å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ï¼");
};

// æª”æ¡ˆé¸å–åµæ¸¬èˆ‡é å¡«
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');

dropZone.onclick = () => fileInput.click();
fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file) return;
  
  // ä¿®æ­£ DataTransfer æŒ‡æ´¾
  const dt = new DataTransfer();
  dt.items.add(file);
  fileInput.files = dt.files;

  dropZone.innerText = `å·²é¸å–: ${file.name}`;
  document.getElementById('displayName').value = file.name.substring(0, file.name.lastIndexOf('.'));
  
  const ext = file.name.split('.').pop().toLowerCase();
  const emojiMap = { 'pdf': 'ğŸ“•', 'jpg': 'ğŸ¨', 'png': 'ğŸ–¼ï¸', 'mp4': 'ğŸ¬', 'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'zip': 'ğŸ“¦' };
  document.getElementById('emoji').value = emojiMap[ext] || 'ğŸ“„';
};

// ä¸Šå‚³é‚è¼¯
window.upload = async () => {
  const file = fileInput.files[0];
  if (!file) return alert("è«‹å…ˆé¸å–æª”æ¡ˆ");
  
  const btn = document.getElementById('upBtn');
  btn.disabled = true;
  btn.innerText = "æ­£åœ¨ä¸Šå‚³...";

  const fileName = `${Date.now()}-${file.name.replace(/\s+/g, '_')}`;
  
  try {
    const { error: storageErr } = await supabase.storage.from("Files").upload(fileName, file);
    if (storageErr) throw storageErr;

    await supabase.from("files").insert({
      storage_path: fileName,
      display_name: document.getElementById('displayName').value || file.name,
      category: document.getElementById('category').value || "æœªåˆ†é¡",
      emoji: document.getElementById('emoji').value || 'ğŸ“„'
    });

    alert("ä¸Šå‚³æˆåŠŸï¼åˆ¥å¿˜äº†ä¸‹ä¸€æ­¥å»åŒ¯å‡º JSONã€‚");
    location.reload(); 
  } catch (err) {
    alert("éŒ¯èª¤: " + err.message);
    btn.disabled = false;
    btn.innerText = "ä¸Šå‚³è‡³ Supabase";
  }
};

// åˆ—è¡¨èˆ‡åˆ†é¡é¸å–®é‡æ–°æ•´ç†
async function refreshList() {
  const { data } = await supabase.from("files").select("*").order("created_at", { ascending: false });
  
  // æ›´æ–° Datalist å»ºè­°é¸é …
  const cats = [...new Set(data.map(item => item.category))];
  document.getElementById('categoryOptions').innerHTML = cats.map(c => `<option value="${c}">`).join('');
  
  const listDiv = document.getElementById("list");
  listDiv.innerHTML = data.map(f => `
    <div class="file-item">
      <span style="font-size:24px">${f.emoji || 'ğŸ“„'}</span>
      <div style="flex:1">
        <b style="font-size:14px">${f.display_name}</b><br>
        <small style="color:var(--secondary)">${f.category}</small>
      </div>
      <div class="actions">
        <button class="btn-del" onclick="deleteFile('${f.id}', '${f.storage_path}')">åˆªé™¤</button>
      </div>
    </div>
  `).join('');
}

window.deleteFile = async (id, path) => {
  if (confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿåˆªé™¤å¾Œä¹Ÿéœ€è¦é‡æ–°åŒ¯å‡º JSON æ‰æœƒç”Ÿæ•ˆã€‚")) {
    await supabase.storage.from("Files").remove([path]);
    await supabase.from("files").delete().eq('id', id);
    refreshList();
  }
};
</script>
</body>
</html>