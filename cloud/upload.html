<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud Manager | Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../shared.css">
    <style>
        body { background: var(--bg-alt); padding-bottom: 50px; }
        .upload-card { background: white; padding: 32px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; }
        .drop-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; color: var(--text-secondary); cursor: pointer; background: #fafafa; transition: 0.2s; }
        .drop-zone:hover { border-color: var(--accent-blue); background: #f0f7ff; }
        .fields-grid { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 12px; margin-top: 20px; }
        .file-list-item { background: white; padding: 16px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
    </style>
</head>
<body>

<nav class="navbar">
    <div class="nav-content">
        <a href="index.html" class="nav-brand">‚òÅÔ∏è Cloud Manager</a>
        <div class="nav-links">
            <a href="index.html" class="nav-item">Library</a>
            <a href="exporter.html" class="nav-item">Export to Native</a>
            <a href="../index.html" class="nav-item">Portal</a>
        </div>
    </div>
</nav>

<div class="container">
    <div id="loginBox" class="upload-card" style="text-align:center; margin-top: 40px;">
        <h2 style="font-size: 20px; margin-bottom: 8px;">Admin Login</h2>
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 24px;">Please login to manage the dynamic database.</p>
        <input id="email" type="email" placeholder="Enter your email" style="max-width:320px;" />
        <button onclick="login()" class="btn" style="max-width:320px;">Send Magic Link</button>
    </div>

    <div id="uploadBox" style="display:none; margin-top: 32px;">
        <div class="info-box">
            <b>Maintenance Tip:</b> After uploading, remember to use the <b>Exporter</b> to sync these changes to your Native Fail-Safe version.
        </div>
        
        <div class="upload-card">
            <div id="dropZone" class="drop-zone">Click or Drop PDF to Detect Metadata</div>
            <input type="file" id="fileInput" style="display:none" />
            
            <div class="fields-grid">
                <input id="emoji" placeholder="Emoji" />
                <input id="displayName" placeholder="Display Name" />
                <input id="category" list="catOptions" placeholder="Category" />
                <datalist id="catOptions"></datalist>
            </div>
            <button id="upBtn" onclick="upload()" class="btn" style="margin-top: 16px;">Upload to Supabase</button>
        </div>

        <h3 style="font-size: 14px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">Existing Cloud Resources</h3>
        <div id="list"></div>
    </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
const supabase = createClient("https://cvuigmevznxkgnmleuta.supabase.co", "sb_publishable_jbiNfw9ST_LSxlYuDNR3Ag_RymggO6q")

supabase.auth.onAuthStateChange((_, s) => {
    if(s) { document.getElementById('loginBox').style.display='none'; document.getElementById('uploadBox').style.display='block'; refreshList(); }
});

window.login = async () => {
    const email = document.getElementById('email').value;
    const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
    if (error) alert(error.message); else alert("Login link sent! Please check your inbox.");
};

const fileInput = document.getElementById('fileInput');
document.getElementById('dropZone').onclick = () => fileInput.click();
fileInput.onchange = () => {
    const f = fileInput.files[0]; if(!f) return;
    document.getElementById('dropZone').innerText = `Selected: ${f.name}`;
    document.getElementById('displayName').value = f.name.split('.').shift();
    const ext = f.name.split('.').pop().toLowerCase();
    const map = { 'pdf':'üìï', 'jpg':'üé®', 'png':'üñºÔ∏è', 'mp4':'üé¨' };
    document.getElementById('emoji').value = map[ext] || 'üìÑ';
};

window.upload = async () => {
    const f = fileInput.files[0]; if(!f) return alert("Please select a file first.");
    const btn = document.getElementById('upBtn'); btn.disabled = true; btn.innerText = "Processing...";
    const path = `${Date.now()}-${f.name.replace(/\s+/g,'_')}`;
    try {
        await supabase.storage.from("Files").upload(path, f);
        await supabase.from("files").insert({
            storage_path: path,
            display_name: document.getElementById('displayName').value,
            category: document.getElementById('category').value || "General",
            emoji: document.getElementById('emoji').value || "üìÑ"
        });
        location.reload();
    } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Upload to Supabase"; }
};

async function refreshList() {
    const { data } = await supabase.from("files").select("*").order("created_at", {ascending:false});
    const cats = [...new Set(data.map(i => i.category))];
    document.getElementById('catOptions').innerHTML = cats.map(c => `<option value="${c}">`).join('');
    document.getElementById('list').innerHTML = data.map(f => `
        <div class="file-list-item">
            <span style="font-size: 24px;">${f.emoji}</span>
            <div style="flex:1">
                <b style="font-size: 14px;">${f.display_name}</b><br>
                <small style="color: var(--text-secondary);">${f.category}</small>
            </div>
            <button onclick="deleteFile('${f.id}','${f.storage_path}')" style="color: var(--danger); border:none; background:none; cursor:pointer; font-size: 13px; font-weight: 600;">Delete</button>
        </div>
    `).join('');
}

window.deleteFile = async (id, path) => {
    if(confirm("Are you sure you want to delete this file from the cloud?")) {
        await supabase.storage.from("Files").remove([path]);
        await supabase.from("files").delete().eq('id', id);
        refreshList();
    }
};
</script>
</body>
</html>